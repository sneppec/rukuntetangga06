<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pembukuan Keuangan Pemuda — Firebase</title>
  <style>
    :root{ --bg:#0b0c10; --card:#111218; --muted:#9aa3af; --text:#e5e7eb; --accent:#6ee7b7; --blue:#60a5fa; --danger:#ef4444; --border:#1f2430; --sticky:#0f1117; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";background:linear-gradient(180deg,#0b0c10 0%,#0a0b0f 100%);color:var(--text)}
    .wrap{max-width:1100px;margin:0 auto;padding:24px}
    header{display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:space-between;margin-bottom:16px}
    .title{display:flex;flex-direction:column;gap:6px}
    h1{font-size:22px;margin:0;letter-spacing:.3px}
    .subtitle{font-size:12px;color:var(--muted);display:flex;gap:10px;align-items:center}

    .toolbar{display:flex;gap:8px;flex-wrap:wrap}
    button,.input{height:36px;border-radius:12px;border:1px solid var(--border);background:var(--card);color:var(--text);padding:0 12px;cursor:pointer;transition:transform .05s ease,box-shadow .2s ease}
    button:hover{box-shadow:0 6px 18px rgba(0,0,0,.35)}
    button:active{transform:translateY(1px)}
    .btn{border-color:#1f2937;background:linear-gradient(180deg,#151823,#0d1117)}
    .btn-accent{border-color:#114534;background:linear-gradient(180deg,#0f2f26,#0c231c);color:#d1fae5}
    .btn-blue{border-color:#12325a;background:linear-gradient(180deg,#0f2541,#0b1b2f);color:#dbeafe}
    .btn-danger{border-color:#3a1111;background:linear-gradient(180deg,#2a0e0e,#1d0a0a);color:#fecaca}

    .panel{border:1px solid var(--border);background:var(--card);border-radius:16px;overflow:hidden}
    .controls{display:flex;gap:12px;flex-wrap:wrap;align-items:center;padding:12px;border-bottom:1px solid var(--border);background:rgba(255,255,255,0.02)}
    .controls .input{height:38px}

    .table-wrap{overflow:auto}
    table{border-collapse:separate;border-spacing:0;width:100%;min-width:780px}
    thead th{position:sticky;top:0;background:var(--sticky);z-index:2;border-bottom:1px solid var(--border)}
    th,td{padding:8px 10px;border-right:1px solid var(--border);border-bottom:1px solid var(--border);white-space:nowrap;text-align:left;font-size:12px}
    th{text-align:center;font-weight:600}
    td.num, th.num{text-align:right}
    tbody tr:nth-child(odd){background:rgba(255,255,255,0.02)}
    tbody tr:hover{background:rgba(255,255,255,0.04)}

    .footer{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;color:var(--muted);font-size:12px}
    .pill{padding:4px 8px;border-radius:999px;border:1px solid var(--border);font-size:11px;color:var(--muted)}

    dialog{border:1px solid var(--border);background:var(--card);color:var(--text);border-radius:16px;padding:0;max-width:520px}
  /* login modal small tweaks */
  .login-modal{min-width:320px;border-width:2px;box-shadow:0 20px 40px rgba(0,0,0,0.4)}
  .login-modal .modal-head{background:var(--sticky);padding:16px}
  .login-modal .modal-body{padding:18px;display:flex;flex-direction:column;gap:12px}
  .login-modal .field input{height:40px;background:var(--card);border-color:var(--border)}
  .login-error{color:var(--danger);font-size:13px;margin-top:-6px}
    .modal-head{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
    .modal-body{padding:16px;display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .modal-body .full{grid-column:1 / -1}
    .modal-actions{display:flex;gap:8px;justify-content:flex-end;padding:14px 16px;border-top:1px solid var(--border)}
    .field{display:flex;flex-direction:column;gap:6px}
    .field label{font-size:12px;color:var(--muted)}
    .field input, .field textarea{height:36px;border-radius:10px;border:1px solid var(--border);background:#0e1116;color:var(--text);padding:0 10px}
    textarea{height:72px;padding:10px;resize:vertical}

    .toast{position:fixed;right:16px;bottom:16px;background:linear-gradient(180deg,#0f2f26,#0c231c);color:#d1fae5;border:1px solid #114534;padding:10px 14px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.35);opacity:0;pointer-events:none;transform:translateY(10px);transition:opacity .25s ease,transform .25s ease;font-size:13px;z-index:50}
    .toast.show{opacity:1;transform:translateY(0)}

    .status{display:inline-flex;gap:6px;align-items:center}
    .dot{width:8px;height:8px;border-radius:50%;background:#ef4444}
    .dot.online{background:#22c55e}
    /* When .no-actions is present on the table, hide the action column (last column) */
    table.no-actions th:last-child,
    table.no-actions td:last-child {
      display: none;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">
        <h1>Pembukuan Keuangan Pemuda</h1>
        <div class="subtitle">
          <span>Kolom: Tanggal · Keterangan · Debet · Kredit · Saldo</span>
          <span class="pill status"><span id="connDot" class="dot"></span><span id="connText">Offline / Local</span></span>
        </div>
      </div>
      <div class="toolbar">
        <button id="btnAdd" class="btn-accent" disabled style="display:none">Tambah Transaksi</button>
        <button id="btnSaldoAwal" class="btn-blue" disabled style="display:none">Set Saldo Awal</button>
        <button id="btnExport" class="btn" style="display:none">Ekspor CSV</button>
        <button id="btnImport" class="btn" disabled style="display:none">Impor JSON</button>
        <button id="btnReset" class="btn-danger" title="Hapus semua data" disabled style="display:none">Reset</button>
        <button id="btnAuth" class="btn">Login Admin</button>
      </div>
    </header>

      <!-- Login Modal -->
      <dialog id="loginModal" class="login-modal">
        <div class="modal-head">
          <strong>Login Admin</strong>
          <button id="closeLogin" class="btn-danger" aria-label="Tutup">✕</button>
        </div>
        <form method="dialog" id="loginForm">
          <div class="modal-body">
            <div class="field full">
              <label for="loginIdentifier">Email atau Username</label>
              <input id="loginIdentifier" type="text" required placeholder="Masukkan email atau username" autocomplete="username" />
            </div>
            <div class="field">
              <label for="loginPassword">Password</label>
              <input id="loginPassword" type="password" required placeholder="Masukkan password" autocomplete="current-password" />
            </div>
            <div id="loginError" class="login-error" style="display:none"></div>
            <div class="modal-actions">
              <button type="submit" class="btn btn-accent">Masuk sebagai Admin</button>
            </div>
          </div>
        </form>
      </dialog>

    <div class="panel">
      <div class="controls">
        <span class="pill">Total Debet: <strong id="totD">Rp0</strong></span>
        <span class="pill">Total Kredit: <strong id="totK">Rp0</strong></span>
        <span class="pill">Saldo Akhir: <strong id="saldoAkhir">Rp0</strong></span>
        <span style="margin-left:auto;display:flex;gap:8px;align-items:center">
          <label class="pill" for="filterDari">Filter tanggal</label>
          <input id="filterDari" class="input" type="date" />
          <span>—</span>
          <input id="filterSampai" class="input" type="date" />
          <button id="btnFilter" class="btn" style="display:none">Terapkan</button>
          <button id="btnClearFilter" class="btn" style="display:none">Bersihkan</button>
        </span>
      </div>
      <div class="table-wrap">
        <table id="table">
          <thead>
            <tr>
              <th style="min-width:120px">Tanggal</th>
              <th style="min-width:220px">Keterangan</th>
              <th class="num" style="min-width:120px">Debet (Rp)</th>
              <th class="num" style="min-width:120px">Kredit (Rp)</th>
              <th class="num" style="min-width:120px">Saldo (Rp)</th>
              <th style="min-width:80px">Aksi</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>a
        </table>
      </div>
      <div class="footer">
        <span>Saldo dihitung otomatis: saldo sebelumnya + debet − kredit.</span>
        <span id="rowCount">0 transaksi</span>
      </div>
    </div>
  </div>

  <!-- Modal Transaksi -->
  <dialog id="trxModal">
    <div class="modal-head">
      <strong id="modalTitle">Tambah Transaksi</strong>
      <button id="closeTrx" class="btn-danger" aria-label="Tutup">✕</button>
    </div>
    <form method="dialog">
      <div class="modal-body">
        <div class="field">
          <label for="trxDate">Tanggal</label>
          <input id="trxDate" type="date" required />
        </div>
        <div class="field full">
          <label for="trxKet">Keterangan</label>
          <input id="trxKet" type="text" placeholder="mis. Iuran kegiatan, sewa bus, donasi" required />
        </div>
        <div class="field">
          <label for="trxDebet">Debet (Rp)</label>
          <input id="trxDebet" type="number" min="0" step="1" placeholder="0" />
        </div>
        <div class="field">
          <label for="trxKredit">Kredit (Rp)</label>
          <input id="trxKredit" type="number" min="0" step="1" placeholder="0" />
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn" id="saveTrx">Simpan</button>
      </div>
    </form>
  </dialog>

  <!-- Modal Saldo Awal -->
  <dialog id="saldoModal">
    <div class="modal-head">
      <strong>Set Saldo Awal</strong>
      <button id="closeSaldo" class="btn-danger" aria-label="Tutup">✕</button>
    </div>
    <form method="dialog">
      <div class="modal-body">
        <div class="field">
          <label for="saldoAwal">Saldo Awal (Rp)</label>
          <input id="saldoAwal" type="number" min="0" step="1" placeholder="0" />
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn" id="saveSaldo">Simpan</button>
      </div>
    </form>
  </dialog>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-database-compat.js"></script>
  <script type="module" src="../js/role-guard.js"></script>

  <script>
    // === CONFIG: ganti sesuai project Anda (contoh dari RT-06) ===
    const firebaseConfig = {
      apiKey: "AIzaSyC63Y9hW7S9GoPfJrvwYVXIuzLO85J93UQ",
      authDomain: "rt-06-c854f.firebaseapp.com",
      databaseURL: "https://rt-06-c854f-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "rt-06-c854f",
      storageBucket: "rt-06-c854f.firebasestorage.app",
      messagingSenderId: "337211904633",
      appId: "1:337211904633:web:e574354d9b8c134d9bfaa8",
      measurementId: "G-GEGJC9V4RF"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();
    const DB_ROOT = 'keuangan_pemuda_v1';

    let isAdmin = false;
    let state = { saldoAwal:0, items:[] };

    // === UI Helpers ===
    const rp = (n)=> new Intl.NumberFormat('id-ID',{style:'currency',currency:'IDR',maximumFractionDigits:0}).format(Number(n||0)).replace('IDR','Rp');
    const toast = (msg)=>{ const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2000); };
    const setAdminEnabled = (en)=>{
      ['btnAdd','btnSaldoAwal','btnImport','btnReset','saveTrx','saveSaldo'].forEach(id=>{ const el=document.getElementById(id); if(el) el.disabled=!en; });
    };
    function setConnStatus(online){
      const dot = document.getElementById('connDot');
      const txt = document.getElementById('connText');
      if(online){ dot.classList.add('online'); txt.textContent='Online / Firebase'; }
      else { dot.classList.remove('online'); txt.textContent='Offline / Local'; }
    }

    // === Auth ===
    const loginModal = document.getElementById('loginModal');
    const loginForm = document.getElementById('loginForm');
    const loginError = document.getElementById('loginError');
    const closeLogin = document.getElementById('closeLogin');

    document.getElementById('btnAuth').addEventListener('click', async ()=>{
      if(auth.currentUser){ await auth.signOut(); return; }
      // show modal
      loginForm.reset(); loginError.style.display = 'none'; loginModal.showModal();
    });

    closeLogin.addEventListener('click', ()=> loginModal.close());

    async function findEmailByUsername(username){
      try{
        const snap = await db.ref('admins').orderByChild('username').equalTo(username).once('value');
        if(!snap.exists()) throw new Error('username_not_found');
        const ud = snap.val(); const rec = Object.values(ud)[0]; if(!rec || !rec.email) throw new Error('invalid_user_data');
        return rec.email;
      }catch(e){ console.error('findEmailByUsername', e); if(e.code==='PERMISSION_DENIED') throw new Error('network_error'); throw e; }
    }

    loginForm.addEventListener('submit', async (ev)=>{
      ev.preventDefault(); const identifier = document.getElementById('loginIdentifier').value.trim(); const password = document.getElementById('loginPassword').value;
      if(!identifier || !password){ loginError.textContent='Mohon isi semua field'; loginError.style.display='block'; return; }
      const submitBtn = ev.submitter || loginForm.querySelector('button[type="submit"]'); submitBtn.disabled=true; const orig = submitBtn.textContent; submitBtn.textContent='Memproses...'; loginError.style.display='none';
      try{
        let email = identifier;
        if(!identifier.includes('@')){ email = await findEmailByUsername(identifier); }
        await auth.signInWithEmailAndPassword(email, password);
        loginModal.close(); toast('Login berhasil');
      }catch(err){ console.error('Login error:', err); let msg='Login gagal'; if(err.message==='username_not_found') msg='Username tidak ditemukan'; else if(err.code==='auth/wrong-password') msg='Password salah'; else if(err.code==='auth/invalid-email') msg='Format email tidak valid'; else if(err.message==='network_error') msg='Gagal terhubung ke server'; loginError.textContent=msg; loginError.style.display='block'; }
      finally{ submitBtn.disabled=false; submitBtn.textContent=orig; }
    });

    auth.onAuthStateChanged(async (user)=>{
      // Default to non-admin until DB verification passes
      isAdmin = false;
      document.getElementById('btnAuth').textContent = user ? 'Logout' : 'Login Admin';
      setAdminEnabled(false);

      // Hide all action buttons by default
      ['btnAdd','btnSaldoAwal','btnExport','btnImport','btnReset','btnFilter','btnClearFilter'].forEach(id=>{ const el=document.getElementById(id); if(el) el.style.display='none'; });

      if (!user) {
        // No user signed in
        return;
      }

      try {
        // Verify that this uid exists under /admins
        const adminSnap = await db.ref(`admins/${user.uid}`).once('value');
        if (adminSnap.exists()) {
          isAdmin = true;
          setAdminEnabled(true);
          // Show admin controls
          ['btnAdd','btnSaldoAwal','btnExport','btnImport','btnReset','btnFilter','btnClearFilter'].forEach(id=>{ const el=document.getElementById(id); if(el) el.style.display=''; });
          toast('Login sebagai admin: ' + (adminSnap.val().username || user.email || user.uid));
          render(currentFilter());
        } else {
          // Signed in but not an admin record
          isAdmin = false;
          setAdminEnabled(false);
          toast('Akun Anda tidak terdaftar sebagai admin');
          render(currentFilter());
          // Optionally sign out the user to avoid confusion (commented out):
          // await auth.signOut();
        }
      } catch (err) {
        console.error('Error verifying admin record:', err);
        toast('Gagal memverifikasi status admin');
      }
    });

    // Firebase connection status
    let rootRef = null;

    const connectedRef = db.ref('.info/connected');
    connectedRef.on('value', (snap) => {
      const connected = !!snap.val();
      if (connected) {
        setConnStatus(true);
        // Attach realtime listener for everyone (read-only for guests; writes still require admin)
        attachRealtime();
      } else {
        setConnStatus(false);
        // Detach to stop listening when offline
        detachRealtime();
        toast('Koneksi terputus - data mungkin tidak terupdate');
      }
    });

    // === Realtime listeners ===
    function attachRealtime(){
      if(rootRef) return;
      rootRef = db.ref(DB_ROOT);
      rootRef.on('value', (snap)=>{
        const v = snap.val();
        if(v && typeof v === 'object'){
          state.saldoAwal = Number(v.saldoAwal||0);
          // items disimpan sebagai objek {id: {..}}
          const objItems = v.items || {};
          state.items = Object.keys(objItems).map(id=> ({ id, ...objItems[id] }))
            .sort((a,b)=> (a.date>b.date?1:a.date<b.date?-1: a.id.localeCompare(b.id)));
        } else {
          state = { saldoAwal:0, items:[] };
        }
        render(currentFilter());
        // Persist a local copy so guests/offline can still view last known data
        saveLocal();
      }, (err)=>{
        console.error('Realtime read error:', err);
        if (err && err.code === 'PERMISSION_DENIED'){
          toast('Akses ditolak: periksa rules Firebase (mode lokal)');
          // detach to avoid repeated callbacks
          detachRealtime();
          return;
        }
        toast('Gagal membaca Firebase, mode lokal');
      });
    }
    
    // (Local cache removed) All data will be loaded from RTDB only.
  function detachRealtime(){ try{ if(typeof rootRef !== 'undefined' && rootRef){ rootRef.off(); rootRef = null; } }catch(e){ console.warn('detachRealtime safe-guard:', e); } }

    // === State Management ===
    const defaultState = {saldoAwal:0, items:[]};
    function resetState(){ state = {...defaultState}; }

    // === RTDB Operations ===
    async function saveToRTDB(){
      if(!rootRef || !isAdmin) return;
      try {
        const itemsObj = {};
        state.items.forEach(item => {
          itemsObj[item.id] = {
            date: item.date,
            desc: item.desc,
            debit: item.debit,
            kredit: item.kredit
          };
        });
        await rootRef.set({
          saldoAwal: state.saldoAwal,
          items: itemsObj
        });
        // Update local cache after successful save
        saveLocal();
      } catch(err) {
        console.error('Failed to save to RTDB:', err);
        toast('Gagal menyimpan ke database');
        throw err;
      }
    }

    // === Render ===
    function sortItems(){ state.items.sort((a,b)=> (a.date>b.date?1:a.date<b.date?-1: a.id.localeCompare(b.id))); }
    function render(filter){
      // Toggle action column visibility based on isAdmin
      try{
        const tableEl = document.getElementById('table');
        if(tableEl){
          if(!isAdmin) tableEl.classList.add('no-actions'); else tableEl.classList.remove('no-actions');
        }
      }catch(e){/* ignore */}
      sortItems();
      const tbody = document.getElementById('tbody');
      tbody.innerHTML='';
      let saldo = Number(state.saldoAwal||0);
      let totD=0, totK=0;
      
      const items = state.items.filter(it=>{
        if(!filter) return true; 
        const d=it.date; 
        if(filter.dari && d < filter.dari) return false; 
        if(filter.sampai && d > filter.sampai) return false; 
        return true;
      });
      
      for(const it of items){
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td>${it.date}</td>
          <td>${escapeHtml(it.desc)}</td>
          <td class="num">${rp(it.debit)}</td>
          <td class="num">${rp(it.kredit)}</td>
          <td class="num">${rp(saldo + Number(it.debit||0) - Number(it.kredit||0))}</td>
          <td>
            ${isAdmin ? `<button class="btn" style="height:28px" data-act="edit" data-id="${it.id}">Edit</button><button class="btn-danger" style="height:28px" data-act="del" data-id="${it.id}">Hapus</button>` : `<span style="color:var(--muted)">&mdash;</span>`}
          </td>`;
        saldo += Number(it.debit||0) - Number(it.kredit||0);
        tbody.appendChild(tr);
      }

      tbody.querySelectorAll('button[data-act]').forEach(btn=>{
        btn.addEventListener('click', (e)=>{
          const id=e.currentTarget.getAttribute('data-id');
          const act=e.currentTarget.getAttribute('data-act');
          if(act==='edit') editRow(id); else if(act==='del') delRow(id);
        });
      });

      document.getElementById('totD').textContent = rp(items.reduce((s,it)=>s+Number(it.debit||0),0));
      document.getElementById('totK').textContent = rp(items.reduce((s,it)=>s+Number(it.kredit||0),0));
      document.getElementById('saldoAkhir').textContent = rp(saldo);
      document.getElementById('rowCount').textContent = items.length + ' transaksi';
    }
    function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }

    // === Filter ===
    function currentFilter(){ const dari = document.getElementById('filterDari').value || null; const sampai = document.getElementById('filterSampai').value || null; return (dari||sampai) ? {dari,sampai} : null; }
    document.getElementById('btnFilter').addEventListener('click', ()=> render(currentFilter()));
    document.getElementById('btnClearFilter').addEventListener('click', ()=>{ document.getElementById('filterDari').value=''; document.getElementById('filterSampai').value=''; render(null); });

    // === CRUD (admin only) ===
    const trxModal = document.getElementById('trxModal');
    const trxDate = document.getElementById('trxDate');
    const trxKet = document.getElementById('trxKet');
    const trxDebet = document.getElementById('trxDebet');
    const trxKredit = document.getElementById('trxKredit');
    const modalTitle = document.getElementById('modalTitle');
    let editId = null;

    document.getElementById('btnAdd').addEventListener('click', ()=>{ if(!isAdmin) return; editId=null; modalTitle.textContent='Tambah Transaksi'; trxDate.value=''; trxKet.value=''; trxDebet.value=''; trxKredit.value=''; trxModal.showModal(); });
    document.getElementById('closeTrx').addEventListener('click', ()=> trxModal.close());

    document.getElementById('saveTrx').addEventListener('click', async (e)=>{
      e.preventDefault(); 
      if(!isAdmin) return;
      
      const date = trxDate.value; 
      const desc = trxKet.value.trim(); // Changed from ket to desc
      const debit = Math.max(0, parseInt(trxDebet.value||'0',10)); // Changed from debet to debit
      const kredit = Math.max(0, parseInt(trxKredit.value||'0',10));
      
      if(!date || !desc){ toast('Lengkapi tanggal & keterangan'); return; }
      if(debit>0 && kredit>0){ toast('Pilih salah satu: debet ATAU kredit'); return; }
      if(debit===0 && kredit===0){ toast('Isi debet atau kredit'); return; }

      const btn = e.target;
      btn.disabled = true;
      
      try{
        if(editId){
          await db.ref(`${DB_ROOT}/items/${editId}`).update({ 
            date, 
            desc, 
            debit, 
            kredit 
          });
        }else{
          const newRef = db.ref(`${DB_ROOT}/items`).push();
          await newRef.set({ 
            date, 
            desc, 
            debit, 
            kredit 
          });
        }
        trxModal.close(); 
        toast('Tersimpan');
        saveLocal();
      }catch(err){ 
        console.error('Save transaction error:', err); 
        toast('Gagal menyimpan'); 
      } finally {
        btn.disabled = false;
      }
    });

    async function editRow(id){ 
      if(!isAdmin) return; 
      const snap = await db.ref(`${DB_ROOT}/items/${id}`).get(); 
      if(!snap.exists()) return; 
      const it=snap.val(); 
      editId=id; 
      modalTitle.textContent='Edit Transaksi'; 
      trxDate.value=it.date||''; 
      trxKet.value=it.desc||''; // Changed from ket to desc for consistency
      trxDebet.value=it.debit||0; // Changed from debet to debit for consistency
      trxKredit.value=it.kredit||0; 
      trxModal.showModal(); 
    }

    async function delRow(id){ 
      if(!isAdmin) return; 
      if(!confirm('Hapus transaksi ini?')) return; 
      try{ 
        await db.ref(`${DB_ROOT}/items/${id}`).remove(); 
        toast('Terhapus'); 
        saveLocal();
      }catch(e){ 
        console.error('Delete error:', e); 
        toast('Gagal menghapus'); 
      } 
    }

    // Saldo awal
    const saldoModal = document.getElementById('saldoModal');
    const saldoAwalInput = document.getElementById('saldoAwal');
    document.getElementById('btnSaldoAwal').addEventListener('click', async ()=>{ 
      if(!isAdmin) return; 
      try {
        const snap = await db.ref(`${DB_ROOT}/saldoAwal`).get(); 
        saldoAwalInput.value = Number(snap.val()||0); 
        saldoModal.showModal();
      } catch(e) {
        console.error('Failed to get saldo awal:', e);
        toast('Gagal mengambil saldo awal');
      }
    });
    document.getElementById('closeSaldo').addEventListener('click', ()=> saldoModal.close());
    // Reset all data
    document.getElementById('btnReset').addEventListener('click', async ()=>{ 
      if(!isAdmin) return; 
      if(!confirm('HAPUS SEMUA DATA?')) return; 
      
      const btn = document.getElementById('btnReset');
      btn.disabled = true;
      
      try {
        // Reset all data in RTDB
        await db.ref(DB_ROOT).set({
          saldoAwal: 0,
          items: null // null will remove the items node entirely
        });
        toast('Data direset');
        saveLocal();
      } catch(err) {
        console.error('Reset error:', err);
        toast('Gagal mereset data');
      } finally {
        btn.disabled = false;
      }
    });

    document.getElementById('saveSaldo').addEventListener('click', async (e)=>{ 
      e.preventDefault(); 
      if(!isAdmin) return; 
      
      const btn = e.target;
      btn.disabled = true;
      
      try{ 
        const saldo = Math.max(0, parseInt(saldoAwalInput.value||'0',10));
        await db.ref(`${DB_ROOT}/saldoAwal`).set(saldo);
        saldoModal.close(); 
        toast('Saldo awal disimpan');
        saveLocal();
      }catch(err){ 
        console.error('Save saldo error:', err); 
        toast('Gagal menyimpan saldo');
      } finally {
        btn.disabled = false;
      }
    });

    // Export CSV (read-only, selalu boleh)
    // Ensure export visible to everyone
    try{ document.getElementById('btnExport').style.display=''; }catch(e){}
    document.getElementById('btnExport').addEventListener('click', ()=>{
      const items = state.items.slice();
      let saldo = Number(state.saldoAwal||0);
      const header = ['tanggal','keterangan','debet','kredit','saldo'];
      const rows = items.map(it=>{ saldo += Number(it.debit||0) - Number(it.kredit||0); return [it.date, escapeCsv(it.desc||it.ket), it.debit||0, it.kredit||0, saldo]; });
      const csv = [header.join(','), ...rows.map(r=> r.join(','))].join('\n');
      download('pembukuan.csv', csv);
    });

    function escapeCsv(s){
      if (s == null) return '';
      const q = '"';
      if (/[,"\n\r]/.test(String(s))) return q + String(s).replace(/"/g, '""') + q;
      return String(s);
    }

    function download(filename, text){ const blob=new Blob([text],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=filename; a.click(); URL.revokeObjectURL(url); }

    // Import JSON (admin only) — expected format: { saldoAwal:number, items:[{date,desc,debit,kredit}] }
    document.getElementById('btnImport').addEventListener('click', ()=>{
      if(!isAdmin) return;
      const inp=document.createElement('input'); inp.type='file'; inp.accept='application/json';
      inp.addEventListener('change', ()=>{
        const f=inp.files[0]; if(!f) return; const rd=new FileReader();
        rd.onload=async()=>{
          try{
            const obj=JSON.parse(rd.result);
            if(!obj || typeof obj!=='object' || !Array.isArray(obj.items)) throw new Error('Format tidak sesuai');
            const updates={};
            updates[`${DB_ROOT}/saldoAwal`] = Number(obj.saldoAwal||0);
            const base=`${DB_ROOT}/items`;
            for(const x of obj.items){
              const id = db.ref(base).push().key;
              updates[`${base}/${id}`] = {
                date: String(x.date||''),
                desc: String(x.desc || x.ket || ''),
                debit: Number(x.debit || x.debet || 0),
                kredit: Number(x.kredit || 0)
              };
            }
            await db.ref().update(updates);
            toast('Impor berhasil');
            saveLocal();
          }catch(e){
            alert('Gagal impor: '+e.message);
          }
        };
        rd.readAsText(f);
      });
      inp.click();
    });

    // Init: start with default state; realtime listener will populate from RTDB when connected
    (function init(){ state = {...defaultState}; render(null); })();
  </script>
</body>
</html>

